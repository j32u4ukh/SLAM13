# 影像間匹配點

## 特徵點法

特徵是影像資訊的另一種數位表達形式，在相機運動後保持穩定，能夠從影像中判斷哪些地方是同一點。將特徵點看作固定在 3D 空間的不動點，根據它們在相機中的投影位置，透過最小化『重投影誤差(Reprojection error)』來最佳化相機運動。

特徵點具有以下特質：

1. 可重複性(Repeatability)：相同的特徵可以在不同的影像中找到。
2. 可區別性(Distinctiveness)：不同的特徵有不同的表達。
3. 高效率(Efficiency)：同一影像中，特徵點的數量應遠小於像素的數量。
4. 本機性(Locality)：特徵只與一小片影像區域相關。

特徵點由『關鍵點』和『描述子』兩部份組成。

* 關鍵點(Key-Point)：指該特徵點在影像裡的位置，有些特徵點還具有朝向、大小等資訊。
* 描述子(Descriptor)：通常是一個向量，描述該關鍵點周圍像素的資訊。按照『外觀相似的特徵應該有相似的描述子』的原則設計，因此，只要兩個特徵點的描述子在向量空間上的距離相近，就可以認為它們是同樣的特徵。

### 特徵點/關鍵點 簡介：

1. 尺度不變特徵轉換(Scale-Invariant Feature Transform, SIFT)：考慮在影像轉換過程中出現的光源、尺度、旋轉等變化，但計算量也相當大。

有些特徵算法適當的降低精度和堅固性，以提升計算的速度。

2. FAST 角點分析：找出影像中的『角點』，屬於計算特別快的一種算法(是一種關鍵點，因此沒有描述子)。不具有方向性。

3. ORB(Oriented FAST and Rotated BRIEF)：是非常具有代表性的即時影像特徵。它改進了 FAST 檢測子不具有方向性的問題，並採用速度極快的二進位描述子 BRIEF(Binary Robust Independent Elementary Feature)，使整個影像特徵分析的環節大幅加速。

### 特徵比對

由於影像特徵的局部特性，誤符合(比對錯誤)的情況廣泛存在。部份原因是因為場景中經常存在大量的重複紋理，使得特徵描述十分困難。

這裡暫不考慮誤符合的情況：

1. 『暴力比對(Brute-Force Matcher)』，利用『漢明距離』作為度量，衡量兩兩特徵點之間的距離。最簡單的特徵比對方法。當特徵點數量很大時，運算量將變得很大，不符合 SLAM 的即時性需求。
2. 快速近似最近鄰(FLANN)演算法

## 直接法

// TODO: 極線搜索；逆深度；塊比對；像素梯度問題；影像間的轉換

* 直接法是由光流法演變而來，具有相同的假設條件。光流描述了像素在影像中的運動，而直接法則附帶一個相機運動模型。

* 特徵點法只能恢復成稀疏地圖；直接法可以恢復成半稠密甚至是稠密地圖。

* 『特徵法』中的特徵比對，『直接法』透過最小化『光度誤差(Photometric error)』來求得點與點之間的對應關係。

* 直接法根據影像的『像素灰階資訊/亮度資訊』同時估計相機運動和點的投影，不要求分析的點必須為角點，甚至可以是隨機的選點，完全不用計算關鍵點和描述子。

* 直接法避免了『計算特徵的時間』，也避免了『特徵缺失的情況』。只要場景中存在明暗變化(可以是漸層，不形成局部的影像梯度)，直接法就能工作。

* 在光流法中，1. 先追蹤特徵點的位置 2. 根據 1 估計的位置確定相機的運動。然而這種兩步走的方案(1 → 2)，很難保障全域的最佳性。
而直接法可在後一步，調整前一步的結果(2 → 1)。

假設對於參考影像，測量到一個灰階值為 229 的像素，利用三角測量等方式知道了深度，可以推測空間點 P 的位置。

之後又獲得一幅新的影像，根據前面反覆運算的最佳化結果來估計它的位姿，獲得灰階值為 126，此像素的光度誤差為 229 - 126 ＝ 103。

為了減小這個誤差，會**微調相機的位姿，使像素更亮一些**。

位姿的調整會根據局部的像素梯度，但由於真實影像並不是光滑的，此方法只在該像素附近有效。

只有當相機運動很小，影像中的梯度不會有很強的非凸性時，才能降低落入局部極小值得可能，使直接法得以成立。

> 前項利用單個像素來進行相機位姿估計，會有『單一像素沒有區分度』的問題產生，因為相似灰階值的像素太多了。通常會計算『影像塊』或是『相關性』。

### 光流法

光流是一種描述像素隨時間在影像之間移動的方法。隨著時間的流逝，同一個像素會在影像中運動，而我們希望追蹤它的運動過程。

**稀疏光流**：計算部份的像素運動，以 Lucas-Kanade(LK) 光流為代表；**稠密光流**：計算『所有』像素的運動，以 Horn-Schunck(HS) 光流為代表。

#### Lucas-Kanade 光流

![Lucas-Kanade 光流](image/LucasKanade.png)

LK 光流認為來自相機的影像是隨時間變化的，影像灰階可看作時間和位置的函數。

**灰階不變假設**：同一個空間點的像素灰階值，在各個影像中是固定不變的。

對於 t 時刻位於 (x, y) 處的像素，令 t + dt 時刻運動到 (x + dx, y + dy) 處，由於灰階不變假設，有： I(x + dx, y + dy, t + dt) = I(x, y, t)。

> 『灰階不變假設』是一個很強的假設，實際中很有可能不成立。

##### 多層光流

如果相機運動較快，兩張影像差異較明顯，那麼『單層影像光流法』容易達到一個『局部極小值』，這種情況可以利用影像金字塔來改善。

**影像金字塔**：對同一影像進行縮放，獲得不同解析度下的影像。

### 極線搜索 與 區塊比對

左側相機觀測到某像素 p1，由於只有一幅影像無法知道深度，只知道對應的空間點位於 (O1p1) 射線上。

(O1p1) 射線投影到右側相機上，形成**極線**，空間點所映射的 p2 亦位於該極線上。

不像特徵法可以利用特徵比對來找到 p2，單一像素又沒有區分性，因此極線搜索利用**區塊比對**來進行比較。

然而演算法的假設，也從『像素的灰階不變性』變成『影像塊的灰階不變性』，變得更強了。

『極線搜索』 ≠ 『直接法』，但從直接比較像素的角度看，這種作法和直接法有異曲同工之妙。

區塊比對常見有以下幾種計算方式：

1. SAD(Sum of Absolute Difference)：接近 0 表示相似；接近 1 表示不相似。

2. SSD(Sum of Squared Distance)：接近 0 表示相似；接近 1 表示不相似。

3. NCC(Normalized Cross Correlation，歸一化互相關)：因為世紀算相關性，因此接近 1 表示相似；接近 0 表示不相似。

4. 還可以將方法 2, 3 先去除平均值再計算，允許像『小區塊 B 比 A 整體上亮一些，但仍然很相似』的情況。

即便使用區塊比對，相似分數在搜索距離較長時，仍會獲得一個非凸函數，該分佈存在許多峰值。此情況下通常會使用機率分佈來描述深度值。

此時問題便轉變成：在不斷對不同影像進行極線搜索時，估計的深度分佈將發生怎樣的變化，即所謂的**深度濾波器**。

![NCC matching score](image/ncc_matching_score.png)

> 像素梯度的問題

>> 區塊比對的正確與否，依賴於影像塊是否具有區分度(具有明顯梯度 或 具有紋理的物體)。

>> 有時可能發生『影像塊本身具有區分度，但梯度方向與極線之間夾角過大』，導致相似分數過低。

### 逆深度

我們利用機率分佈來描述深度值，但場景深度大約在 5 ~ 10 公尺，可能有一些更遠的點，但近處一定不會小於相機焦距(或認為深度不會小於 0)。

這個分佈不像高斯分佈，不是一個對稱的形狀，而是尾部較長，而負數區域則為 0。

假設深度的倒數，即**逆深度**，為高斯分佈是比較有效的。

P(d^-1) = N(μ, σ^2)

當再次觀測到該像素點： P(d_obs^-1) = N(μ_obs, σ_obs^2)。

將兩次觀測後所產生的高斯分佈融合，以更新原本的 d^-1 的分佈：

![d_fuse^-1](image/d_fuse.png)

由於僅有觀測方程式，而沒有運動方程式，這裡的深度僅用到了資訊融合部份，而無須像完整的卡爾曼那樣預測和更新，
也可以把它看成『運動方程視為深度固定不動』的卡爾曼濾波器。

<table>
  <tr>
    <td><a href="https://j32u4ukh.github.io/SLAM13/class4.html">上一篇</a></td>
    <td><a href="https://j32u4ukh.github.io/SLAM13/">首頁</a></td>
    <td><a href="https://j32u4ukh.github.io/SLAM13/class6.html">下一篇</a></td>
  </tr>
</table>