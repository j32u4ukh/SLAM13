# 回路檢測

由於這一次的估計，是基於前一次估計結果來進行的，隨著時間，估計誤差也不斷累積著。

相機運動的過程中，當發生回到同一點(例如相機 C 和 D 拍攝到同一地點)時，估計的軌跡也應該經過同一點。
但在前端的估計有誤差，不斷累積便會造成 C 和 D 的位置估計產生誤差。

若能觀察到實際的位置，就能降低估計的不確定性。根據 C 和 D 的誤差來修正到同一個位置時，前面的估計也會有相對應的修正，消弭前面累積的誤差。回到同一點這件事稱為『回路』。

用默數讀秒來舉例，在心中讀秒時每一秒都可能和實際的一秒有所偏差(運動估計有誤差)，下一次讀秒又是基於前面有誤差的讀秒，時間越長誤差越大。若此時可以看一下實際的時間(觀測到回路，進行運度的再估計，此估計應該還是會有誤差，但遠小於長時間累計下來的誤差)，便可知道自己的讀秒和實際的誤差，並修正這個誤差。

## 回路檢測意義

回路檢測對整個 SLAM 系統精度和穩健性的提昇是非常明顯的。

1. 確保估計的軌跡和地圖在**長時間**下的正確性。
2. 提供『目前資料與所有歷史資料的連結』，進行**重定位**。若我們事先對某個場景錄製了一條軌跡並建立了地圖，之後在該場景就可以隨著這條軌跡進行導航，而『重定位』可以幫助我們確定本身在這條軌跡上的位置。

## 檢測方法

*回路檢測的關鍵，就是如何有效的檢測出**相機經過同一地點**這件事。*

1. 『假定任兩張圖像之間都可能存在回路，並兩兩影像做一遍特徵比對。』隨著影像增加，計算量增加的過於快速，且該假設並不合理。

至少應預計"哪裡可能出現回路"，才不至於盲目的檢測。

2. 以『里程計為基礎(Odometry based)』的幾何關係。當發現相機運動到了之前的某個位置附近時，檢測他們有沒有回路關係。但由於誤差累積的關係，經常無法發現這個狀況，也無從談起回路檢測。

3. 以『外觀為基礎(Appearance based)』的幾何關係。與前後端的估計都無關，僅根據兩幅影像的相似性確定回路檢測關係。此種作法擺脫了誤差累積，使回路檢測模組成為 SLAM 系統中一個相對獨立的模組(當然前端可為它提供特徵點)。

### 外觀為基礎的回路檢測

核心問題為：**如何計算影像間的相似性？**

可能方法：

1. 『兩圖轉為灰階後直接相減』：灰階為不穩定的測量值，嚴重受到環境光源和相機曝光影響。且當相機發生微小變化，即使像素值不變，由於像素位置發生改變，兩者差距也會變大。不是一個好的評估方式。

2. 利用特徵點搭配詞袋模型，不直接使用特徵比對，而是用『影像上有哪幾種特徵』來描述一幅影像。檢測到兩幅影像滿足回路時，進行特徵比對，估計兩者的相對運動。將估計後的運動，放入位姿圖來修正之前估計的誤差。

### 準確率 和 召回率

如何衡量函數『衡量影像間相似程度』的好壞？

<table>
  <tr>
    <td><b>演算法/事實</b></td>
    <td><b>是回路</b></td>
    <td><b>不是回路</b></td>
  </tr>
  <tr>
    <td><b>是回路</b></td>
    <td>真陽性(TP)</td>
    <td>假陽性(FP)</td>
  </tr>
  <tr>
    <td><b>不是回路</b></td>
    <td>假陰性(FN)</td>
    <td>真陰性(TN)</td>
  </tr>
</table>

* 『假陽性(False Positive)』又稱為『感知偏差(Perceptual Aliasing)』。
* 『假陰性(False Negative)』又稱為『感知變異(Perceptual Variability)』。

* 準確率(Precision, P) = TP / (TP + FP)
* 召回率(Recall, R) = TP / (TP + FN)

為了評估演算法的好壞，會測試它在各種設定 P 和 R 值，畫出 Precision-Recall 曲線。

而在 SLAM 當中，對準確率的要求更高，而對召回率相對寬容一些。


### Key frame 的處理

1. Key frame 不能選得太近，否則彼此之間都太相似，反而無法檢測出回路。最好是足夠稀疏，彼此不太相同，但又能涵蓋整個環境。

2. 在檢測回路時，當發現第一幀和第 n 幀形成回路時，和第 n + 1 幀、第 n + 2 幀應該也會形成回路。第一次形成回路時，便將先前的誤差給校正了，後面幾幀所形成的相同回路,無法提供更多資訊，通常會將這些相近的回路聚集為一種，使演算法不要反覆檢測同一種回路。


<table>
  <tr>
    <td><a href="https://j32u4ukh.github.io/SLAM13/class8.html">上一篇</a></td>
    <td><a href="https://j32u4ukh.github.io/SLAM13/">首頁</a></td>
    <td><a href="https://j32u4ukh.github.io/SLAM13/class10.html">下一篇</a></td>
  </tr>
</table>