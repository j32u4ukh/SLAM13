# 前端：區塊比對

## 影像間的轉換

假設了影像小區塊在相機運動時保持不變，而這個假設在相機平移時能夠保持成立，但當相機發生明顯的旋轉時，就難以繼續保持了。

比如相機繞光心旋轉，一塊上黑下白的影像可能變成上白下黑，導致相關係數直接變成負數(儘管仍是同一個區塊)。

為防止這種情況的出現，通常需要在塊比對之前，把參考頁框和目前頁框之間的運動考慮。根據相機模型，參考頁框上的一個像素 P_R 與真實的 3D 點世界座標 P_W 有以下關係：

```
d_R * P_R = K(R_RW * P_W + t_RW)。
```

對於目前頁框，亦有 P_W 在它上面的投影，記作 P_C：

```
d_C * P_C = K(R_CW * P_W + t_CW)。
```

代入並消去 P_W，即得兩幅影像之間的像素關係：

![兩幅影像之間的像素關係](image/formula12_14.png)

當知道 d_R, P_R 時，可以計算出 P_C 的投影位置。此時，再給 P_R 兩個分量個一個增量 du ＆ dv，就可以求得 P_C 的增量 duc, dvc。透過這種方式，算出在局部範圍內參考頁框和目前頁框影像座標轉換的一個線性關係組成仿射轉換：

![仿射轉換](image/formula12_15.png)

根據仿射轉換矩陣，我們可以將目前頁框(或參考頁框)的像素進行轉換，再進行塊比對，以期獲得對旋轉更好的效果。

